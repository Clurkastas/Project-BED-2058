---
title: "Which is the best country to live in?"
author: "Kirill Tumanov, Mattia Storero, Lucas Stark"
date: "14 12 2019"
output: 
  html_document:
    number_sections: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
rm(list=ls()) #delete workspace
knitr::opts_chunk$set(echo = F, include = T, warning=F, error=F)

### Cleaning and Visualizing
library(maps) #this way we can visualize data on maps (-> world map)
library(tidyverse) #basic cleaning/ organising functions
library(plotrix) #3D pie chart
library(ggpubr) #chart mattia
library(DescTools) # %like% function
library(kableExtra)

#load data
#data was gathered and cleand in "DataCollectionAndCleaning.R"
dat_raw  <- read.csv("dat_raw.csv")
dat_wide <- read.csv("dat_wide.csv")
dat_long <- read.csv("dat_long.csv")


```

# Background
The idea of this project was created in middle of September 2019.
Three guys, from different lands had some discussions about their countries.
Then, we started to think about particular question:
"Which is the world's best country to live in?"

To receive an answer for this attractive question we decided to select some 
variables, which were considerable for us.


```{r pie chart, include = T}
# 3D Exploded Pie Chart
slices <- c(20, 20, 20, 20, 20)
lbls <- c("Health", "Economics", "Safety", "Education", "Environment")
pie3D(slices,labels=lbls,explode=0.1,
   main="Pie Chart of Variables ")
```

The first significant indicator for us was health, which included: 
Life expectancy (gapminder)
Child mortality (The world bank data)
Survival to age 65 by both genders (The world bank data)
Water Supply (The world bank data)

The second essential variable for us was Economics (Jobs/ Income), which included:
Inequality, gini coefficient (The world bank data)
Income, GDP (gapminder)
Unemployment rate at the age of 25 - 54 (The world bank data)

The third vital marker for us was Safety, which included:
Traffic deaths (gapminder)
Murders/100k (The world bank data)

The fourth considerable indicator for us was Education, which included:
Gender ratio of mean age in education (The world bank data)
Mean years in school (age group 25-54) (The world bank data)

The fifth substantial marker for us was Environment, we used:
CO2 emissions, tonnes per person (The world bank data)
Air pollution (The world bank data)

# Research Question
To create a well-developed project, we asked the following questions:
What is the current state of the indicator (2019 or the last year)?
How is it distributed over the continents?

# Data Acquisition

As a source of data we considered different sources. These were gapminder, World Development Indicators (WDI), OECD, Quandl and eurostat. Because OECD had only information on OECD countries that source had to be left out from the beginning. Quandl and eurostat were excluded because they shared the most important data with WDI. Also overall, their data quality was worse. So in the end, the data was acquired from the gapminder dataset of the gapminder Rpackage and and API to WDI. WDI provides data from multiple original sources, e.g. UNESCO Institute for Statistics, LAC Equity Lab and data they gathered on their own. 
Variables were searched for each of the selected topics and selected on the basis of their quality, e.g. amount of missings and great enough variance.

# Data Analysis

## Factor Analysis

To find out which variables we could use properly, we sorted the chosen variables  into our five overarching topics. After sorting, we conducted a confirmatory factor analysis for each topic. Unfit variables were sorted out and are depicted in red color in the table below. Factor scores were used for further analysis.

```{r variables yeah}
Health <- c("% Survival to age 65 (male)",
            "% Survival to age 65 (female)",
            "Life Expectancy",
            "% Access to clean cooking",
            "Child mortality per 1,000 live births")
Economy <- c("GDP per capita","Gini Coefficient","Unemployment","","")
Safety <- c("Mortality due to bad hygiene and unclean water per 1,000",
            "Mortality due to traffic accidents per 1,000",
            "Mortality due to unintended poisoning per 1,000","",
            "Mortality due to homicide per 1,000")
Education <- c("% of children in primary education",
               "% of children in secondary education",
               "% of students receive monetary support from government in primary education",
               "% of students receive monetary support from government in secondary education",
               "Male to female ratio in secondary education") #this one didn't make it
Environment <- c("Air pollution",
                 "CO2 emmissions","",
                 "Level of water stress",  #this is out
                 "Renewable internal freshwater resources per capita") #this is out
topictable <- cbind(Health,Economy,Safety,Education,Environment)
rm(Health,Economy,Safety,Education,Environment)

#make table
topictable %>% 
  knitr::kable(format = "html", caption = "Life Quality Factors") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  row_spec(5, color = "red") %>%
  column_spec(1, color = "black") %>%
  column_spec(5, color = "red") %>%
  row_spec(1:2, color = "black")
```



## General Life Quality

```{r analysis beginning, include = T}
temp <- dat_wide %>%
  mutate(meta = (envir + health + econ + educ + secu)/5) %>%
  arrange(-meta) %>%
  mutate(worst10 = as.factor(ifelse(rank(meta)<=10,1,0)),
         top10 = as.factor(ifelse(rank(meta)>=(length(meta)-10),1,0)))

#world map
thismap <- map_data("world")
thismap$region[thismap$region=="Democratic Republic of the Congo"] <- "Congo, Dem. Rep."
thismap$region[thismap$region=="Republic of Congo"] <- "Congo, Rep."
temp2 <- temp[,c("country","meta")]
temp2$country <- as.character(temp2$country)
temp2$country[temp2$country=="United States"] <- "USA"
temp2$country[temp2$country=="United Kingdom"] <- "UK"
thismap2 <- full_join(thismap, temp2, 
                     by = c("region" = "country")) 
ggplot(thismap2, aes(long, lat, group=group, fill=meta), color = "white") +
  scale_fill_gradient(limits=range(thismap2$meta), low="red", high="green", na.value = "white") + 
  geom_polygon(show.legend = T) +
  scale_y_continuous(limits = c(-60,max(thismap$lat))) + 
  coord_fixed(1.3) + #this makes the right proportions for the image
  theme(panel.background = element_rect(fill = 'lightblue', colour = 'black'))+
  ggtitle("Life Quality across the World")

#meta and population
temp %>%
  ggplot(aes(x=log10(pop), y=meta, col=continent, label=country, size=pop)) +
  geom_point() +
  geom_smooth(col="blue", method = 'lm') +
  ggtitle("Life Quality dependend on Population Size")

```

What this method does?
For this method, we created a new variable, which is called "meta". It includes sum of 5 variables 
such as environment, health, economics, education and security. After we divided it for 5 (number of variables) and arranged it.

What is the result of it?
According for our data, the best country to live in is Norway with 1.81 points, the second place Ireland takes and the
third is Singapore. On the bottom of our rating is located Chad.


```{r}
ggplot(data = temp[c(1:10,(length(temp$country)-10):length(temp$country)),], mapping = aes(x = -rank(meta), y = meta,  fill = continent)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=country, y = meta/2), size = 5, angle = 90) +
labs(x = "Countries", y = "Points", title = "Top 10 and Bottom 10 Countries in Life Quality")

```

This graph shows us top 10 best countries for living and top 10 worst countries. We ranked them by continents.

## Health - Lucas

For measuring health we included five different variables: the percentage of people getting to the age of 65 seperate for men and women, the life expectancy, acces to clean cooking possibilities and child mortality. They are depicted in the plot below with the health factor on the x-axis and the individual variables on the y-axis. The top and bottom ten from the general life quality measurement are displayed as green and red points, respectively.

```{r health}
health <- c("surv_65m","surv_65f","lifeExp","cook","child_mor")

temp_h <- dat_long[str_detect(dat_long$variable,paste(health, collapse="|")),]
temp_h <- left_join(temp_h,temp[,c("country","health","top10","worst10")],by="country") %>%
  mutate(variable = as.factor(as.character(temp_h$variable)))
levels(temp_h$variable) <- c("% of men surviving till age 65",
                             "% of women surviving till age 65",
                             "Life Expectancy",
                             "% access for clean cooking",
                             "Child mortality per 1,000 live births")
levels(temp_h$variable) <- rev(levels(temp_h$variable))

#graph
temp_h %>%
  ggplot(aes(x=health, y= measurement, label=country)) +
  geom_point(col="grey") +
  geom_point(dat=temp_h[temp_h$top10==1,], color="green") +
  geom_point(dat=temp_h[temp_h$worst10==1,], color="darkred") +
  geom_text(dat=temp_h[temp_h$worst10==1,], aes(label=country), alpha=0.7, hjust = -0.1, color="red", size=3) +
  facet_wrap(~variable, scales = "free_y")

```

In order to analyse the sphere of economics, 3 variables have been considered. To make it possible, we have decided to include two of the three fundamental economic variables: GDP per capita and the unemployment rate. The GDP PER CAPITA is a measure of a country's economic output that accounts for its number of people. The unemployment rate was selected because is the most important variable to determine the health of the economy in the country. The inflation rate (the third fundamental variable) has not been considered because it is not directly connected to the satisfaction rate of living. Instead of it, we have thought that it would have been more interesting to consider the GINI COEFFICIENT, which measures the equality in income distribution. Putting together this three values, these graphs were created.


## Economy - Mattia
```{r}
ggplot2::ggplot(data = temp[c(1:10,(length(temp$country)-10):length(temp$country)),], mapping = aes(x = -rank(econ), y = econ,  fill = continent)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=country, y = econ/2), size = 5, angle = 90)

ggplot(data = dat_long[dat_long$variable=="gdpPercap"& dat_long$country=="Norway"|dat_long$variable=="gini"& dat_long$country=="Norway"|dat_long$variable=="unemp" & dat_long$country=="Norway",], mapping = aes(x = country, y = measurement,  fill = variable, group = variable)) +
  geom_bar(stat = "identity",position = "dodge") #+
  geom_text(aes(label=country, y = econ/2), size = 5, angle = 90)
  

ep1 <- temp %>% 
  ggplot(aes(x = gdpPercap, y = gini,
             col = continent)) +
  geom_text(dat=temp[temp$top10==1|temp$worst10==1,], aes(label=country)) +
  geom_point()
  
ep2 <- temp %>% 
  ggplot(aes(x = gdpPercap, y = unemp, 
             col = continent)) +
  geom_text(dat=temp[temp$top10==1|temp$worst10==1,], aes(label=country)) +
  geom_point()  
  
  
ep3 <-  temp %>% 
  ggplot(aes(x = gini, y = unemp, 
             col = continent)) +
  geom_text(dat=temp[temp$top10==1|temp$worst10==1,], aes(label=country)) +
  geom_point()
```

## Safety - Kirill
```{r}
ggplot(data = temp[c(1:10,(length(temp$country)-10):length(temp$country)),], mapping = aes(x = -rank(secu), y = secu,  fill = continent)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=country, y = secu/2), size = 5, angle = 90) +
  labs(x = "Countries", y = "Points", title = "Top 10 best and top 10 worst countries for safety") +
  scale_y_continuous(limits =  c(-3.2,1))
```

This graph shows us top 10 best countries, where people can feel them calm and top 10 worst countries for safety.
We ranked them by continents. After we separated safety for 3 variables and made 2 plots.

```{r}
temp %>% 
  ggplot(aes(x = mor_hyg, y = poison,
             col = continent)) +
  geom_point() +
  geom_text(dat=temp[temp$worst10==1,], aes(label=country)) +
  labs(x = "Mortality due to lack of hygiene", y = "Mortality due to unintentional poisoning", title = "Mortality due to lack of hygiene and unintentional poisoning (per 100,000 population)")
```

This graph shows us the rate of mortality due to 2 reasons: mortality due to lack of hygiene and mortality due to unintentional poisoning. It is clearly seen, that African countries are leaders in mortality in both categories.
On the contrary, such occasions are very rare in Europe, America, Asia and Oceania. In these countries, more people have access to clean water and hygiene products. Poisoning are also rare, as there are certain safety measures.

```{r}
temp2 <- temp[c(1:10,(length(temp$country)-10):length(temp$country)),] %>%
  mutate(rank = rank(road))
temp2$rank[temp2$country=="Japan"] <- 5
temp2$rank[temp2$country=="Ireland"] <- 6

ggplot(data = temp2, mapping = aes(x = rank, y = road,  fill = continent)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=country, y = road/2), size = 5, angle = 90) +
   labs(x = "Countries", y = "Mortality on roads", title = "Top 10 best and top 10 worst countries for mortality caused by road traffic injury (per 100,000 people)")
```

This graph shows us the rate of mortality caused by road traffic injury. We put on the graph top 10 best and top 10 worst countries according to this indicator. African countries have high level of road mortality. For example, in Burundi, Congo Dem. Rep., Central African Republic, Cameron and South Sudan >= 30 out of 100,000 people die on roads. As for top best 8 countries, less than 5 out of 100,000 people die on roads.


## Education

For the topic of education, we looked at four variables. Specifically, two of them focus on primary education and the the other two focus on the same aspects in secondary education. The first pair of variables contains information about how many of the children, who have the age to be in that sort of education actually are attending school. The second pair focusses on how many of those students receive monetary payments from their government as a support. All four variables are depicted in the following plot.

```{r, include = T}
educ <- c("pri_ed","sec_ed","pri_mon","sec_mon")
temp_ed <- dat_long[str_detect(dat_long$variable,paste(educ, collapse="|")),]
temp_ed <- left_join(temp_ed,temp[,c("country","educ","top10","worst10")],by="country") %>%
  mutate(variable = as.factor(as.character(temp_ed$variable)))
levels(temp_ed$variable) <- c("% of children in primary education",
                              "% of students receiving govern. payments in pri. ed.",
                              "% of children in secondary education",
                              "% of students receiving govern. payments in sec. ed.")

#graph
temp_ed %>%
  ggplot(aes(x=educ, y= measurement, label=country)) +
  geom_point(col="grey") +
  geom_point(dat=temp_ed[temp_ed$top10==1,], color="green") +
  geom_text(dat=temp_ed[temp_ed$top10==1,], aes(label=country), alpha=0.7, hjust = -0.1, color="darkgreen", size=3) +
  geom_point(dat=temp_ed[temp_ed$worst10==1,], color="darkred")+
  geom_text(dat=temp_ed[temp_ed$worst10==1,], aes(label=country), alpha=0.7, hjust = -0.1, color="red", size=3) +
  facet_wrap(~variable, scales = "free_y")

pri_ed_btm_range <- range(temp_ed$measurement[temp_ed$variable=="% of children in primary education"&temp_ed$worst10==1]) %>% round(digits=2)
sec_ed_btm_range <- range(temp_ed$measurement[temp_ed$variable=="% of children in secondary education"&temp_ed$worst10==1]) %>% round(digits=2)
sec_ed_top_range <- range(temp_ed$measurement[temp_ed$variable=="% of children in secondary education"&temp_ed$top10==1]) %>% round(digits=2)
pay_btm <- temp_ed %>%
  filter(nchar(as.character(variable)) > 40) %>%
  filter(worst10==1) %>% 
  mutate(measurement = round(measurement, digits=2),
         country = as.character(country))
pay_top <- temp_ed %>%
  filter(nchar(as.character(variable)) > 40) %>%
  filter(top10==1) %>% 
  mutate(measurement = round(measurement, digits=2),
         country = as.character(country))

```

In the above plot, you can see the constructed education variable on the x-axis and each of the single variables on the y-axis. As you can see in the upper left block, in the top ten countries almost every child is enrolled in primary education. However, the bottom ten have a larger variance ranging from `r pri_ed_btm_range[1]` to `r pri_ed_btm_range[2]` percent. As a general mean across all countries `r mean(temp_ed$measurement[temp_ed$variable=="% of children in primary education"]) %>% round(digits=2)` percent of children attend in primary education.

The general distrubution of children attend school is way more variant in secondary education. The mean here is `r mean(temp_ed$measurement[temp_ed$variable=="% of children in secondary education"]) %>% round(digits=2)` percent. That is a big difference to primary education which is also reflected by the distribution of the top and bottom ten countries. The top ten countries attendance percentage in secondary education ranges from `r sec_ed_top_range[1]` to `r sec_ed_top_range[2]`, while the bottom tens attendance range lies between `r sec_ed_btm_range[1]` and `r sec_ed_btm_range[2]` percent.

In both variables for governmental payments for students, the bottom ten countries are really low on the scale. The highest of those values is `r max(pay_btm$measurement)` percent of students receiving payments in `r pay_btm$country[max(pay_btm$measurement)]` while the lowest is `r min(pay_btm$measurement)` percent in `r pay_btm$country[min(pay_btm$measurement)]`. The top ten countries are giving monetary payments to more students with also a higher variance. The highest of those values is `r max(pay_top$measurement)` percent in `r pay_top$country[max(pay_top$measurement)]` while the lowest is `r min(pay_top$measurement)` percent in `r pay_top$country[min(pay_top$measurement)]`.

So in an educational view on this topic, it is definitely better to live in the top ten countries because you're probability of attending school and receiving monetary support is higher.


## Environment - Kirill
```{r}
temp %>% 
  ggplot(aes(x = CO2, y = air,
             col = continent)) +
  geom_text(dat=temp[temp$top10==1|temp$worst10==1,], aes(label=country)) +
  geom_point() +
  labs(x = "CO2 emissions", y = "Air pollution, micrograms/cubic meter", title = "Environment in different countries, ranked by continents and 2 variables")
```

This graph shows us environmental situations in different countries. Almost all African countries have a high degree of air pollution, but low CO2 emissions. The situation with european countries is completely different. They have a high level of CO2 emissions and not as much air pollution as African countries.
This may be due to the fact that CO2 emissions in Europe are less toxic due to various technologies that reduce air pollution. There are no such technologies in Africa.

# Conclussion


# Sources

[Thank you for your attention!](https://vivescoal.com.au/wp-content/uploads/2016/12/thank-you-for-your-thank-you-word-cloud-1024x791.jpg)