---
title: "Which is the Best Country to Live in?"
author: "Kirill Tumanov, Mattia Storero, Lucas Stark"
date: "14 12 2019"
output: 
  html_document:
    number_sections: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
rm(list=ls()) #delete workspace
knitr::opts_chunk$set(echo = F, include = T, warning=F, error=F)

### Cleaning and Visualizing
library(maps) #this way we can visualize data on maps (-> world map)
library(tidyverse) #basic cleaning/ organising functions
library(plotrix) #3D pie chart
library(ggpubr) #chart mattia
library(DescTools) # %like% function
library(kableExtra)
library(GGally)
library(hrbrthemes)
library(data.table)

#load data
#data was gathered and cleand in "DataCollectionAndCleaning.R"
dat_raw  <- read.csv("dat_raw.csv")
dat_wide <- read.csv("dat_wide.csv")
dat_long <- read.csv("dat_long.csv")


```

# Background
The idea of this project was created in middle of September 2019.
We, three guys from different countries, had some discussions about our countries and how it was to live there.
Then, we started to think about one particular question:
"Which is the world's best country to live in?"

To get an answer for this question of life quality, we decided to select some topics, which were considerable for us.


```{r pie chart, include = T}
# 3D Exploded Pie Chart
slices <- c(20, 20, 20, 20, 20)
lbls <- c("Health", "Economics", "Safety", "Education", "Environment")
pie3D(slices,labels=lbls,explode=0.1,
   main="Pie Chart of Variables ")

```

The first significant topic for us was health as it is an obvious indicator of life quality and we knew that data like life expectancy was well accessible.
The second essential variable for us was economics as the economic situation of a country is crucial for one's own situation.
How much income one gets and whether employment is secured does inflict life quality.
The third vital marker for us was safety. 
Everyone wants to feel secure. 
The fourth considerable indicator for us was education. 
Good education helps to get ready for the job market and is important for personal development.
The fifth substantial marker for us was environment.
Factors like CO2 emissions may not affect just the one country, but air pollution can inflict health and well-being.

# Research Question
To create a well-developed project, we asked the following research questions:
What is the best country to live in based on health, education, economy, safety and environment?
How is it distributed over the continents? 
What additional information can we draw from the top and bottom ten countries looking at each indivual topic?

# Data Acquisition

As far as the sources of data are concerned, we considered different sources. These were gapminder, World Development Indicators (WDI), OECD, Quandl and eurostat.
Because OECD had only information on OECD countries that source had to be left out from the beginning. Quandl and eurostat were excluded because they shared the most important data with WDI. 
Also overall, their data quality was worse in order to get a clear analysis.
So in the end, the data was acquired from the gapminder dataset of the gapminder Rpackage and and API to WDI. WDI provides data from multiple original sources, e.g. UNESCO Institute for Statistics, LAC Equity Lab and data they gathered on their own. 
Variables were searched for each of the selected topics and selected on the basis of their quality, e.g. amount of missings and great enough variance. Because not all data was available for this or last year, we decided to take the most current data point from between the years 2000 and 2019 for each country.

# Data Analysis

## Factor Analysis

To find out which variables we could use properly, we sorted the chosen variables into our five overarching topics.
After sorting, we conducted a confirmatory factor analysis for each topic. Unfit variables were sorted out and are depicted in red color in the table below.
Factor scores were used for further analysis.

```{r variables yeah}
Health <- c("% Survival to age 65 (male)",
            "% Survival to age 65 (female)",
            "Life Expectancy",
            "% Access to clean cooking",
            "Child mortality per 1,000 live births")
Economy <- c("GDP per capita","Gini Coefficient","Unemployment","","")
Safety <- c("Mortality due to bad hygiene and unclean water per 1,000",
            "Mortality due to traffic accidents per 1,000",
            "Mortality due to unintended poisoning per 1,000","",
            "Mortality due to homicide per 1,000")
Education <- c("% of children in primary education",
               "% of children in secondary education",
               "% of students receive monetary support from government in primary education",
               "% of students receive monetary support from government in secondary education",
               "Male to female ratio in secondary education") #this one didn't make it
Environment <- c("Air pollution",
                 "CO2 emmissions","",
                 "Level of water stress",  #this is out
                 "Renewable internal freshwater resources per capita") #this is out
topictable <- cbind(Health,Economy,Safety,Education,Environment)
rm(Health,Economy,Safety,Education,Environment)

#make table
topictable %>% 
  knitr::kable(format = "html", caption = "Life Quality Factors") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  row_spec(5, color = "red") %>%
  column_spec(1, color = "black") %>%
  column_spec(5, color = "red") %>%
  row_spec(1:2, color = "black")


```



## Method

All five variables for the individual topics were weighted equally to create the meta variable of life quality. With this particular methosd, we were able to have a general point of view.
The top and bottom ten countries will be depicted in the next chart. 

## General Life Quality
```{r, echo = F, include = T}
temp <- dat_wide %>%
  mutate(meta = (envir + health + econ + educ + secu)/5) %>%
  arrange(-meta)
temp$topbot10 <- "neither"
temp$topbot10[1:10] <- "Top 10"
temp$topbot10[(length(temp$topbot10)-9):length(temp$topbot10)] <- "Bottom 10"

populationdata <- read.csv2("populationWDI.csv", header = T)
populationdata <- populationdata[,c(1,63)] 
names(populationdata) <- c("country","population")
temp$country <- as.character(temp$country)
populationdata$country <- as.character(populationdata$country)
populationdata$population <- as.numeric(populationdata$population)
populationdata$country[populationdata$country=="Bahamas, The"] <- "Bahamas"
populationdata$country[populationdata$country=="Russian Federation"] <- "Russia"
populationdata$country[populationdata$country=="Iran, Islamic Rep."] <- "Iran"
populationdata$country[populationdata$country=="Egypt, Arab Rep."]   <- "Egypt"
populationdata$country[populationdata$country=="Syrian Arab Republic"]   <- "Syria"
populationdata$country[populationdata$country=="Venezuela, RB"]   <- "Venezuela"
populationdata$country[populationdata$country=="Gambia, The"]   <- "Gambia"
populationdata$country[populationdata$country=="Micronesia, Fed. Sts."]   <- "Micronesia"
populationdata$country[populationdata$country=="Yemen, Rep."] <- "Yemen"

temp <- full_join(temp, populationdata, by = "country")
temp <- temp[!is.na(temp$continent),]
temp <- temp[!is.na(temp$population),]
temp <- temp[str_detect(temp$country,"Hong", negate = T),]

# add weighted data for continent means
contitemp <- temp%>%
  group_by(continent) %>%
  summarise(contPop = sum(population))
temp <- temp %>% full_join(contitemp, by = "continent") %>%
  mutate(contweight = population/contPop)


topbottom10 <- temp[temp$topbot10!="neither",] %>%
  rename(`life quality` = meta,
         economy = econ,
         education = educ,
         safety = secu,
         environment = envir)

```


```{r, include = T}
ggplot(data = topbottom10, mapping = aes(x = -rank(`life quality`), y = `life quality`,  fill = continent)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=country, y = `life quality`/2), 
            size = 5, angle = 90) +
labs(x = "Countries", y = "Points", title = "Top 10 and Bottom 10 Countries in Life Quality")

```

As you can see `r topbottom10$country[max(topbottom10[,"life quality"])]` is the top country and therefore has the highest life quality according to our analysis.
Also, other countries from Europe, Oceania and Asia are in the top ten.
In the bottom ten only African countries are represented.

The next graphic shows the world map with colors for each country.
These colors represent the state of life quality of the country from low (red) to high (green). Countries in white color indicate missing values. 




```{r analysis beginning, include = T}
#world map
thismap <- map_data("world")
thismap$region[thismap$region=="Democratic Republic of the Congo"] <- "Congo, Dem. Rep."
thismap$region[thismap$region=="Republic of Congo"] <- "Congo, Rep."
temp2 <- temp[,c("country","meta")]
temp2$country <- as.character(temp2$country)
temp2$country[temp2$country=="United States"] <- "USA"
temp2$country[temp2$country=="United Kingdom"] <- "UK"
thismap2 <- full_join(thismap, temp2, 
                     by = c("region" = "country")) 
ggplot(thismap2, aes(long, lat, group=group, fill=meta), color = "white") +
  scale_fill_gradient(limits=range(thismap2$meta), low="red", high="green", na.value = "white") + 
  geom_polygon(show.legend = T) +
  scale_y_continuous(limits = c(-60,max(thismap$lat))) + 
  coord_fixed(1.3) + #this makes the right proportions for the image
  theme(panel.background = element_rect(fill = 'lightblue', colour = 'black'))+
  ggtitle("Life Quality across the World")
```

As you can see on the world map, each of the continents has different qualitative and quantitative features.
In general, Europe is a rather green country, therefore offers high life quality.
In contrast, Africa is a generally more red continent, therefore offers low life quality. 
The other three continents (Americas, Asia and Oceania) are more diverse and rather in the middle field. Oceania seems to offer rather high life quality, but the smaller countries of it are not that visible. 
To get a better look at the overall life quality per continent, the means are depicted in the following graph. 
They are weighted by population size, so that every country contributes only their percentage of the total population in each continent.


```{r analysis next, include = T}
continentdata <- temp %>%
  group_by(continent) %>%
  summarise(health = sum(health*contweight),
            economy = sum(econ*contweight),
            education = sum(educ*contweight),
            safety = sum(secu*contweight),
            environment = sum(envir*contweight),
            `life quality` = sum(meta*contweight))

ggparcoord(continentdata,
    columns = c("life quality", "health","economy",
                "education","safety","environment"), 
    groupColumn = "continent",
    order = "allClass",
    showPoints = TRUE, 
    title = "Life Quality and Aspects by Continent",
    alphaLines = 0.7) +
  theme_ipsum()+
  theme(
    plot.title = element_text(size=10)
  )
```

As it is possible to observe in this graph, the overall life quality per person is highest in Oceania. 
This is probably due to the high values for Australia and New Zealand. Both countries are in the top ten of life quality. 
Second place is Europe, third is the Americas. These three continents are all above average.
Asia is half a standard deviation below average, and Africa even one and a half standard deviations below it. 
Qualitative differences due to life quality can be seen in the five subdimensions, e.g. Oceania having a really high score in education, and the top three continents being relatively equal in terms of security.
It is interesting to notice that the trends that the american and european continents follow is really similar. Even if the european one is situated slightly elevated they present the same critical points.

In a next step, we will have a quick view on whether life quality correlates with the population size.

```{r analysis pop, include = T}
#meta and population
temp %>%
  ggplot(aes(x=log10(population), y=meta, col=continent, label=country, size=pop)) +
  geom_point() +
  geom_smooth(col="blue", method = 'lm') +
  ggtitle("Life Quality dependend on Population Size")

```

In the plot you can see that there is a slight decrease of life quality with a higher population. 
However, the relationship is not significant.
Therefore, data suggests that life quality is independent from country size.

## Variables

Before focalizing on it, it would be better to concentrate on the single variables.
Now we will look at each subdimension of life quality to get a better understanding of how these add to life quality. 


## Health

For measuring health we included five different variables: the percentage of people getting to the age of 65 seperate for men and women, the life expectancy, acces to clean cooking possibilities and child mortality.
They are depicted in the plot below with the health factor on the x-axis and the individual variables on the y-axis. 
The top and bottom ten from the general life quality measurement are displayed as green and red points, respectively.

```{r health}
health <- c("surv_65m","surv_65f","lifeExp","cook","child_mor")

temp_h <- dat_long[str_detect(dat_long$variable,paste(health, collapse="|")),]
temp_h <- left_join(temp_h,temp[,c("country","health","topbot10")],by="country") %>%
  mutate(variable = as.factor(as.character(temp_h$variable)))
levels(temp_h$variable) <- c("% of men surviving till age 65",
                             "% of women surviving till age 65",
                             "Life Expectancy",
                             "% access for clean cooking",
                             "Child mortality per 1,000 live births")
levels(temp_h$variable) <- rev(levels(temp_h$variable))

#graph
temp_h %>%
  ggplot(aes(x=health, y= measurement, label=country)) +
  geom_point(col="grey") +
  geom_point(dat=temp_h[temp_h$topbot10=="Top 10",], color="green") +
  geom_point(dat=temp_h[temp_h$topbot10=="Bottom 10",], color="darkred") +
  geom_text(dat=temp_h[temp_h$topbot10=="Bottom 10",], aes(label=country), alpha=0.7, hjust = -0.1, color="red", size=3) +
  facet_wrap(~variable, scales = "free_y")


```



## Economy 
In order to analyse the sphere of economics, 3 variables have been considered.
To make it possible, we have decided to include two of the three fundamental economic variables: GDP per capita and the unemployment rate. The GDP PER CAPITA is a measure of a country's economic output that accounts for its number of people. 
The unemployment rate was selected because is the most important variable to determine the health of the economy in the country. 
The inflation rate (the third fundamental variable) has not been considered because it is not directly connected to the satisfaction rate of living. Instead of it, we have thought that it would have been more interesting to consider the GINI COEFFICIENT, which measures the equality in income distribution. 
Putting together this three values, these graphs were created.


```{r}
ggplot2::ggplot(data = topbottom10, mapping = aes(x = -rank(economy), y = economy,  fill = continent)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=country, y = economy/2), size = 5, angle = 90)
```

This graph show the result that comes out putting the three variables together in one called "ECON".
Doing this union, we found a result that is very similar to the ones obtained with the other variables.
In the top ten, there are 5 countries from Europe, 3 from Asia and 2 from Oceania. In this case, Norway is considered the best one.
On the contrary, the outcome that comes out from the worst 10 graph is emblematic. 
In fact, in this special classification we can find only African countries. 


```{r}
#fixed graphs to knit  

ep1 <- temp %>% 
  ggplot(aes(x = gdpPercap, y = gini,
             col = continent)) +
  geom_text(dat=topbottom10, aes(label=country)) +
  geom_point() + labs(x = "GDP per capita", y = "Gini coefficient", title = "Relationship between GDP per capita and GINI index")
ep1

ep2 <- temp %>% 
  ggplot(aes(x = gdpPercap, y = unemp, 
             col = continent)) +
  geom_text(dat=topbottom10, aes(label=country)) +
  geom_point()+ labs(x = "GDP per capita", y = "unemployment rate", title = "Relationship between GDP per capita and unemployment rate")  

ep2 
  
ep3 <-  temp %>% 
  ggplot(aes(x = gini, y = unemp, 
             col = continent)) +
  geom_text(dat=topbottom10, aes(label=country)) +
  geom_point()+ labs(x = "GINI coefficient", y = "unemployment rate", title = "Relationship between GINI index per capita and unemployment rate")
ep3
```




The graphs show the relationship between the three economic variables taken two at a time (in this order: GDP/GINI, GDP/UNEMPLOYMENT, GINI/UNEMPLOYMENT).
The three parallelisms confirm the classification previously obtained. 
In general, it is possible to see that almost the 10 best and worst countries confirm their position in all the three graphs.That could be also a starting point for a further analysis: thanks to the correlation between the economic variables and the aggregated ones, it is possible to conclude that is the economic point view is the direct cause/consequence of a good quality of life.

## Safety 
```{r}
ggplot(data = topbottom10, mapping = aes(x = -rank(safety), y = safety,  fill = continent)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=country, y = safety/2), size = 5, angle = 90) +
  labs(x = "Countries", y = "Points", title = "Top 10 best and top 10 worst countries for safety") +
  scale_y_continuous(limits =  c(-3.2,1))

```

This graph shows us top 10 best countries, where people can feel them calm and top 10 worst countries for safety.
We ranked them by continents. After we separated safety for 3 variables and made 2 plots.

```{r}
temp %>% 
  ggplot(aes(x = mor_hyg, y = poison,
             col = continent)) +
  geom_point() +
  geom_text(dat=temp[temp$topbot10=="Bottom 10",], aes(label=country)) +
  labs(x = "Mortality due to lack of hygiene", y = "Mortality due to unintentional poisoning", title = "Mortality due to lack of hygiene and unintentional poisoning (per 100,000 population)")

```

This graph shows us the rate of mortality due to 2 reasons: mortality due to lack of hygiene and mortality due to unintentional poisoning.
It is clearly seen, that African countries are leaders in mortality in both categories.
On the contrary, such occasions are very rare in Europe, America, Asia and Oceania. In these countries, more people have access to clean water and hygiene products.
Poisoning are also rare, as there are certain safety measures.

```{r}
temp2 <- topbottom10 %>%
  mutate(rank = rank(road))
temp2$rank[temp2$country=="Japan"] <- 5
temp2$rank[temp2$country=="Ireland"] <- 6

ggplot(data = temp2, mapping = aes(x = rank, y = road,  fill = continent)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=country, y = road/2), size = 5, angle = 90) +
   labs(x = "Countries", y = "Mortality on roads", title = "Top 10 best and top 10 worst countries for mortality caused by road traffic injury (per 100,000 people)")

```

This graph shows us the rate of mortality caused by road traffic injury. We put on the graph top 10 best and top 10 worst countries according to this indicator. African countries have high level of road mortality. For example, in Burundi, Congo Dem. Rep., Central African Republic, Cameron and South Sudan >= 30 out of 100,000 people died on roads. As for top best 10 countries, this number is approximately 6 times less.


## Education

For the topic of education, we looked at four variables. Specifically, two of them focus on primary education and the the other two focus on the same aspects in secondary education.
The first pair of variables contains information about how many of the children, who have the age to be in that sort of education actually are attending school.
The second pair focusses on how many of those students receive monetary payments from their government as a support. 
All four variables are depicted in the following plot.

```{r, include = T}
educ <- c("pri_ed","sec_ed","pri_mon","sec_mon")
temp_ed <- dat_long[str_detect(dat_long$variable,paste(educ, collapse="|")),]
temp_ed <- left_join(temp_ed,temp[,c("country","educ","topbot10")],by="country") %>%
  mutate(variable = as.factor(as.character(temp_ed$variable)))
levels(temp_ed$variable) <- c("% of children in primary education",
                              "% of students receiving govern. payments in pri. ed.",
                              "% of children in secondary education",
                              "% of students receiving govern. payments in sec. ed.")

#graph
temp_ed %>%
  ggplot(aes(x=educ, y= measurement, label=country)) +
  geom_point(col="grey") +
  geom_point(dat=temp_ed[temp_ed$topbot10=="Top 10",], color="green") +
  geom_text(dat=temp_ed[temp_ed$topbot10=="Top 10",], aes(label=country), alpha=0.7, hjust = -0.1, color="darkgreen", size=3) +
  geom_point(dat=temp_ed[temp_ed$topbot10=="Bottom 10",], color="darkred")+
  geom_text(dat=temp_ed[temp_ed$topbot10=="Bottom 10",], aes(label=country), alpha=0.7, hjust = -0.1, color="red", size=3) +
  facet_wrap(~variable, scales = "free_y")

pri_ed_btm_range <- range(temp_ed$measurement[temp_ed$variable=="% of children in primary education"&temp_ed$topbot10=="Bottom 10"]) %>% round(digits=2)
sec_ed_btm_range <- range(temp_ed$measurement[temp_ed$variable=="% of children in secondary education"&temp_ed$topbot10=="Bottom 10"]) %>% round(digits=2)
sec_ed_top_range <- range(temp_ed$measurement[temp_ed$variable=="% of children in secondary education"&temp_ed$topbot10=="Top 10"]) %>% round(digits=2)
pay_btm <- temp_ed %>%
  filter(nchar(as.character(variable)) > 40) %>%
  filter(topbot10=="Bottom 10") %>% 
  mutate(measurement = round(measurement, digits=2),
         country = as.character(country))
pay_top <- temp_ed %>%
  filter(nchar(as.character(variable)) > 40) %>%
  filter(topbot10=="Top 10") %>% 
  mutate(measurement = round(measurement, digits=2),
         country = as.character(country))

```

In the above plot, you can see the constructed education variable on the x-axis and each of the single variables on the y-axis. 
As you can see in the upper left block, in the top ten countries almost every child is enrolled in primary education. However, the bottom ten have a larger variance ranging from `r pri_ed_btm_range[1]` to `r pri_ed_btm_range[2]` percent. As a general mean across all countries `r mean(temp_ed$measurement[temp_ed$variable=="% of children in primary education"]) %>% round(digits=2)` percent of children attend in primary education.

The general distrubution of children attend school is way more variant in secondary education.
The mean here is `r mean(temp_ed$measurement[temp_ed$variable=="% of children in secondary education"]) %>% round(digits=2)` percent. That is a big difference to primary education which is also reflected by the distribution of the top and bottom ten countries.
The top ten countries attendance percentage in secondary education ranges from `r sec_ed_top_range[1]` to `r sec_ed_top_range[2]`, while the bottom tens attendance range lies between `r sec_ed_btm_range[1]` and `r sec_ed_btm_range[2]` percent.

In both variables for governmental payments for students, the bottom ten countries are really low on the scale.
The highest of those values is `r max(pay_btm$measurement)` percent of students receiving payments in `r pay_btm$country[max(pay_btm$measurement)]` while the lowest is `r min(pay_btm$measurement)` percent in `r pay_btm$country[min(pay_btm$measurement)]`. The top ten countries are giving monetary payments to more students with also a higher variance. The highest of those values is `r max(pay_top$measurement)` percent in `r pay_top$country[max(pay_top$measurement)]` while the lowest is `r min(pay_top$measurement)` percent in `r pay_top$country[min(pay_top$measurement)]`.

So in an educational view on this topic, it is definitely better to live in the top ten countries because you're probability of attending school and receiving monetary support is higher.


## Environment 
```{r}
temp %>% 
  ggplot(aes(x = CO2, y = air,
             col = continent)) +
  geom_text(dat=topbottom10, aes(label=country)) +
  geom_point() +
  labs(x = "CO2 emissions", y = "Air pollution, micrograms/cubic meter", title = "Environment in different countries, ranked by continents and 2 variables")

```

This graph shows us environmental situations in different countries. Almost all African countries have a high degree of air pollution, but low CO2 emissions.
The situation with european countries is completely different. 
They have a high level of CO2 emissions and not as much air pollution as African countries.
This may be due to the fact that European countries use technologies to reduce air pollution and heighten ecological standards.


## Conclusion

As shown in the chapter above, Norway seems to be the best country to live in based on how we gathered and analyzed the data. 
OECD came to the same conclusion within their [Better Life Index Project](http://www.oecdbetterlifeindex.org/). 
They used more categories and different variables, but answered the question in the same way, which is a nice validation of the result.
Interestingly, five of our top ten countries are also in their top ten.
These are Norway, Australia, Denmark, the Netherlands, and Finland.
This probably means that even if the considered variables are different and even if we used a different method to aggregate them, the core of the two works is the same.

It is possible to notice that the outcome we got is the result of the combination of more factors.
This shows more intersections, especially on the life quality of northern European countries, which seems to be really high.
But in general, it is good to be born in either Oceania or Europe.To be exact the results obtained by the Oceania are strictly connected to the high result of its two most important countries (Australia and New Zealand).
For this reason even if these two countries are, without any doubt, ones of the best countries to live in, this result can not be expand for certain to the the others oceanian countries. As far as the european result is concerned, it necessary to specify and explain some interesting result. The entire continent presents good result in a overall view.
Despite this, it's evident the norther countries scored a higher value in many variables analysis (Economy and Education above all). 
In general, these continent score the highest in mean of life quality in comparison with other continents and have many countries in the top ten. 
An other clarification is necessary for the America's and Asia's situations.
Even if the results are different, it is possible to find some common grounds between them. 
In fact, they have presented an high differentiation within theio own territory.
The good results that United States, Singapore, Japan and Israel have showed are contrasted with the other ones.
As regards USA, the explanation can be found in the bad results of the South America. As regards Singapore, Japan and Israel (3 of the best 10), the explanation can be found in the really different economic and development situations that the Asian continent shows.
From the other end of the scale, the most unsuitable countries for life are the ones of the African continent.
As a matter of fact, it is clearly possible to observe that they made a bad score in every variable that we have selected. 
This tells us that as regards these particular countries, there are many problems that need to be solved.


