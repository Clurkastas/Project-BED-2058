---
title: "Which is the best country to live in?"
author: "Kirill Tumanov, Mattia Storero, Lucas Stark"
date: "14 12 2019"
output: 
  html_document:
    number_sections: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
rm(list=ls()) #delete workspace
knitr::opts_chunk$set(echo = F, include = T, warning=F, error=F)

### Cleaning and Visualizing
library(maps) #this way we can visualize data on maps (-> world map)
library(tidyverse) #basic cleaning/ organising functions
library(plotrix) #3D pie chart
library(ggpubr) #chart mattia

#load data
#data was gathered and cleand in "DataCollectionAndCleaning.R"
dat_raw  <- read.csv("dat_raw.csv")
dat_wide <- read.csv("dat_wide.csv")
dat_long <- read.csv("dat_long.csv")


```

# Background
The idea of this project was created in middle of September 2019.
Three guys, from different lands had some discussions about their countries.
Then, we started to think about particular question:
"Which is the world's best country to live in?"

To receive an answer for this attractive question we decided to select some 
variables, which were considerable for us.


```{r pie chart, include = T}
# 3D Exploded Pie Chart
slices <- c(20, 20, 20, 20, 20)
lbls <- c("Health", "Economics", "Safety", "Education", "Environment")
pie3D(slices,labels=lbls,explode=0.1,
   main="Pie Chart of Variables ")
```

The first significant indicator for us was health, which included: 
Life expectancy (gapminder)
Child mortality (The world bank data)
Survival to age 65 by both genders (The world bank data)
Water Supply (The world bank data)

The second essential variable for us was Economics (Jobs/ Income), which included:
Inequality, gini coefficient (The world bank data)
Income, GDP (gapminder)
Unemployment rate at the age of 25 - 54 (The world bank data)

The third vital marker for us was Safety, which included:
Traffic deaths (gapminder)
Murders/100k (The world bank data)

The fourth considerable indicator for us was Education, which included:
Gender ratio of mean age in education (The world bank data)
Mean years in school (age group 25-54) (The world bank data)

The fifth substantial marker for us was Environment, we used:
CO2 emissions, tonnes per person (The world bank data)
Air pollution (The world bank data)

# Research Question
To create a well-developed project, we asked the following questions:
What is the current state of the indicator (2019 or the last year)?
How did it develop over the years?
How is it distributed over the continents?


# Data Analysis

```{r analysis beginning, include = T}
temp <- dat_wide %>%
  mutate(meta = (envir + health + econ + educ + secu)/5) %>%
  arrange(-meta) %>%
  mutate(worst10 = as.factor(ifelse(rank(meta)<=10,1,0)),
         top10 = as.factor(ifelse(rank(meta)>=(length(meta)-10),1,0)))

#meta and population
temp %>%
  ggplot(aes(x=log10(pop), y=meta, col=continent, label=country, size=pop)) +
  geom_point() +
  geom_smooth(col="blue", method = 'lm')

#world map
thismap <- map_data("world")
thismap$region[thismap$region=="Democratic Republic of the Congo"] <- "Congo, Dem. Rep."
thismap$region[thismap$region=="Republic of Congo"] <- "Congo, Rep."
temp2 <- temp[,c("country","meta")]
temp2$country <- as.character(temp2$country)
temp2$country[temp2$country=="United States"] <- "USA"
temp2$country[temp2$country=="United Kingdom"] <- "UK"
thismap2 <- full_join(thismap, temp2, 
                     by = c("region" = "country")) 

temp3 <- thismap2[is.na(thismap$meta),]
ggplot(thismap2, aes(long, lat, group=group, fill=meta)) +
  scale_fill_gradient(limits=range(thismap2$meta), low="red", high="green") + 
  geom_polygon(show.legend = T) +
  scale_y_continuous(limits = c(-60,max(thismap$lat)))

```

What this method does?
For this method, we created a new variable, which is called "meta". It includes sum of 5 variables 
such as environment, health, economics, education and security. After we divided it for 5 (number of variables) and arranged it.

What is the result of it?
According for our data, the best country to live in is Norway with 1.81 points, the second place Ireland takes and the
third is Singapore. On the bottom of our rating is located Chad.


```{r}
ggplot(data = temp[c(1:10,(length(temp$country)-10):length(temp$country)),], mapping = aes(x = -rank(meta), y = meta,  fill = continent)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=country, y = meta/2), size = 5, angle = 90) +
labs(x = "Countries", y = "Points", title = "Top 10 best and top 10 worst countries for living")

```
This graph shows us top 10 best countries for living and top 10 worst countries. We ranked them by continents.

## Health Variables Lucas
```{r}
ggplot(data = temp[c(1:10,(length(temp$country)-10):length(temp$country)),], mapping = aes(x = -rank(health), y = health,  fill = continent)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=country, y = health/2), size = 5, angle = 90)

health <- c("surv_65m","surv_65f","mortality","lifeExp","cook","child_mor")

temp %>% ggplot(aes(x=surv_65m,y=surv_65f, col=continent)) +
  geom_point() +
  geom_text(dat=temp[temp$top10==1|temp$worst10==1,], aes(label=country))

```

## Economic Variables Mattia
```{r}
ggplot2::ggplot(data = temp[c(1:10,(length(temp$country)-10):length(temp$country)),], mapping = aes(x = -rank(econ), y = econ,  fill = continent)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=country, y = econ/2), size = 5, angle = 90)

dat_raw <- dat_raw %>% 
  mutate(unemp =  rowMeans(cbind(ad_unemp, bas_unemp, int_unemp), na.rm=T))
#preparing for yoy plotting (not so useful, not enough data)
econ_data <- dat_raw %>% select(country, year, gdpPercap, gini, unemp)

econ_data <- econ_data[ which(econ_data$country=="Norway"|
                                econ_data$country=="Singapore"|
                                econ_data$country=="Ireland"),]
econ_data <- econ_data %>% dplyr::distinct(country, year, gdpPercap, gini, unemp)
#fixing
colnames(econ_data)[2] <- "year"
as.character(econ_data$year)
as.Date(as.character(econ_data$year),format="%Y")
#3 graphs
p1econ <- ggplot() + 
  geom_line(aes(y = unemp, x = year, color = country),
      data = econ_data, stat="identity") +
  labs(x="year", y="unemployment rate") +
  ggtitle("Unemployment rate during the years") + scale_y_continuous(limits = c(0,20)) + scale_x_continuous(limits = c(2000,2020))+ theme(axis.text.x = element_text(angle = 90)) + geom_line(aes(y=unemp, x=year, color = country), data = econ_data) +
           theme(legend.title=element_blank())

p2econ <- ggplot() + 
  geom_point(aes(y = gdpPercap, x = year, color = country),
      data = econ_data, stat="identity") +
  labs(x="year", y="Gdp per Capita") +
  ggtitle("Gdp during the years") + scale_y_continuous(limits = c(0,60000)) + scale_x_continuous(limits = c(1970,2020))+ theme(axis.text.x = element_text(angle = 90)) + geom_line(aes(y=gdpPercap, x=year, color = country), data = econ_data) +
           theme(legend.title=element_blank())

p3econ <- ggplot() + 
  geom_point(aes(y = gini, x = year, color = country),
      data = econ_data, stat="identity") +
  labs(x="year", y="Gini rate") +
  ggtitle("Gini rate during the years") + scale_y_continuous(limits = c(20,40)) + scale_x_continuous(limits = c(2000,2020))+ theme(axis.text.x = element_text(angle = 90)) + geom_line(aes(y=gini, x=year, color = country), data = econ_data) +
           theme(legend.title=element_blank())
#put together

figure_econ <- ggarrange(p1econ, p2econ, p3econ,
                    labels = c("A", "B", "C"),
                    ncol = 1, nrow = 3)
figure_econ



```

## Safety Variables Kirill
```{r}
ggplot(data = temp[c(1:10,(length(temp$country)-10):length(temp$country)),], mapping = aes(x = -rank(secu), y = secu,  fill = continent)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=country, y = secu/2), size = 5, angle = 90) +
  labs(x = "Countries", y = "Points", title = "Top 10 best and top 10 worst countries for safety") +
  scale_y_continuous(limits =  c(-3.2,1))

temp %>% 
  ggplot(aes(x = mor_hyg, y = poison,
             col = continent)) +
  geom_point() +
  geom_text(dat=temp[temp$worst10==1,], aes(label=country))

ggplot(data = temp[c(1:10,(length(temp$country)-10):length(temp$country)),], mapping = aes(x = -rank(road), y = road,  fill = continent)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=country, y = road/2), size = 5, angle = 90)

```

## Educational variables Lucas
```{r, include = T}
ggplot(data = temp[c(1:10,(length(temp$country)-10):length(temp$country)),], mapping = aes(x = -rank(educ), y = educ,  fill = continent)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=country, y = educ/2), size = 5, angle = 90)

educ <- c("pri_ed","sec_ed","pri_mon","sec_mon")
temp_ed <- dat_long[str_detect(dat_long$variable,paste(educ, collapse="|")),]
temp_ed <- left_join(temp_ed,temp[,c("country","educ","top10","worst10")],by="country") %>%
  mutate(variable = as.factor(as.character(temp_ed$variable)))
levels(temp_ed$variable) <- c("% of children in primary education",
                              "% of students receiving money transfers from state for primary education",
                              "% of children in secondary education",
                              "% of students receiving money transfers from state for secondary education")

#graph
temp_ed %>%
  ggplot(aes(x=educ, y= measurement, label=country)) +
  geom_point(col="grey") +
  geom_text(dat=temp_ed[temp_ed$top10==1,], aes(label=country), color="green", size=3)+
  geom_text(dat=temp_ed[temp_ed$worst10==1,], aes(label=country), color="red", size=3) +
  facet_wrap(~variable)

```

## Environmental variables Kirill
```{r}
ggplot2::ggplot(data = temp[c(1:10,(length(temp$country)-10):length(temp$country)),], mapping = aes(x = -rank(envir), y = envir,  fill = continent)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=country, y = envir/2), size = 5, angle = 90) +
    labs(x = "Countries", y = "Points", title = "Top 10 best and top 10 worst countries for environment")

temp %>% 
  ggplot(aes(x = CO2, y = air,
             col = continent)) +
  geom_text(dat=temp[temp$top10==1|temp$worst10==1,], aes(label=country)) +
  geom_point()
```

# Conclussion
