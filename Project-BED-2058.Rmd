---
title: "Which is the best country to live in?"
author: "Kirill Tumanov, Mattia Storero, Lucas Stark"
date: "14 12 2019"
output: 
  html_document:
    number_sections: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
rm(list=ls()) #delete workspace
knitr::opts_chunk$set(echo = F, include = F)
### Data
library(WDI) #connection 2 or world bank
library(gapminder) #data from gapminder
### Cleaning and Visualizing
library(rvest) #if we need to harvest data from webpages
library(ggmap) #this way we can visualize data on maps (-> world map)
library(tidyverse) #basic cleaning/ organising functions
library(PerformanceAnalytics)
#Analysis 
library(psych) # for factor analysis
library(Hmisc) # rcorr()
```

# Background
The idea of this project was created in middle of September 2019.
Three guys, from different lands had some discussions about their countries.
Then, we started to think about particular question:
"Which is the world's best country to live in?"

To receive an answer for this attractive question we decided to select some 
variables, which were considerable for us.

The first significant indicator for us was health, which included: 
Life expectancy (gapminder)
Child mortality (gapminder)
Survival to age 65 by both genders (knoema)
Water Supply (knoema)

The second essential variable for us was Economics (Jobs/ Income), which included:
Inequality, gini coefficient (gapminder)
Income, GDP (gapminder)
Unemployment rate at the age of 25 - 54 (gapminder)

The third important indicator for us was Life Satisfaction, we used OECD database.

The fourth vital marker for us was Safety, which included:
Corruption Perception Index (gapminder)
Traffic deaths (gapminder)
Murders/100k (The world bank data)

The fifth considerable indicator for us was Education, which included:
Gender ratio of mean age in education (DATA BASE?)
Mean years in school (age group 25-54) (DATA BASE?)

The sixth substantial marker for us was Environment, we used CO2 emissions, tonnes per person (gapminder)

# Research Question
To create a well-developed project, we asked the following questions:
What is the current state of the indicator (2019 or the last year)?
How did it develop over the years?
How is it distributed over the continents?

# 3D Exploded Pie Chart
library(plotrix)
slices <- c(20, 20, 20, 20, 20)
lbls <- c("Health", "Economics", "Safety", "Education", "Environment")
pie3D(slices,labels=lbls,explode=0.1,
   main="Pie Chart of Variables ")

# Data Sources
```{r import}

### WORLD BANK ###
#- load table with all available variables
WDI_datasets <- as_tibble(WDIcache()$series)
temp <- stringr::str_detect(WDI_datasets[["name"]], "income")
temp2 <- WDI_datasets[temp,]
#temp2[["description"]]
#load datasets:
# HEALTH #######################
WDI_ch_mor <- WDI(indicator = "SP.DYN.IMRT.IN") #Child mortality source 1
WDI_ch_mor2 <- WDI(indicator = "HD.HCI.MORT") #Child mortality source 2
WDI_surv_65f <- WDI(indicator = "SP.DYN.TO65.FE.ZS") #survival to 65, female
WDI_surv_65m <- WDI(indicator = "SP.DYN.TO65.MA.ZS") #survival to 65, male
WDI_mor_hyg <- WDI(indicator = "SH.STA.WASH.P5") #deaths bcs of unclean water & bad hygience
#water is dichotom and has almost no variance
WDI_water2 <- WDI(indicator="SG.H2O.PRMS.HH.ZS") #water access in households
WDI_cook <- WDI(indicator = "EG.CFT.ACCS.ZS	") # access for clean cooking
WDI_mortality <- WDI(indicator = "SH.STA.AIRP.P5") #mortality rate attributed to household and ambient air pollution
# too much missing data
# EDUCATION ##################### Lucas
WDI_pri_Ed <- WDI(indicator = "UIS.NERT.1") # % in primary education
WDI_sec_Ed <- WDI(indicator = "UIS.NERA.3") # % in upper secondary education
WDI_pri_mon <- WDI(indicator = "fin37.t.a.5") # %Gov. transfers money for pri. ed.
WDI_sec_mon <- WDI(indicator = "fin37.t.a.6") # % Gov. transfers money for sec. ed.
WDI_sec_f <- WDI(indicator = "UIS.GTVP.23.GPV.F")
WDI_ed_exp <- WDI(indicator = "UIS.XPUBP.UK")#gov. exp. on ed. %of total exp.
# SAFETY ###################
WDI_road <- WDI(indicator = "SH.STA.TRAF.P5") # traffic deaths per 1000
WDI_pois <- WDI(indicator = "SH.STA.POIS.P5") # poison deaths per 1000
WDI_murder <- WDI(indicator = "VC.IHR.PSRC.P5") #intentional homicide per 100,000
# ECONOMICS ################## Mattia
WDI_gini <- WDI(indicator = "SI.POV.GINI") # Gini Index
#WDI_unemp <- WDI(indicator = "SL.UEM.LTRM.ZS") # % of total Unemployment
WDI_y_unemp <- WDI(indicator = "SL.UEM.1524.NE.ZS	") # % youth unemployment rate 
WDI_ad_unemp <- WDI(indicator = "SL.UEM.ADVN.ZS") # % unemployment rate with advance education 
WDI_int_unemp <- WDI(indicator = "SL.UEM.INTM.ZS") # % unemployment rate with intermediate education
WDI_bas_unemp <- WDI(indicator = "SL.UEM.BASC.ZS") # % unemployment rate with basic education 
WDI_gdp <- WDI(indicator = "6.0.GDPpc_constant") # per capita gdp
WDI_gdpgr <- WDI(indicator = "6.0.GDP_growth") #gdp growth

# ENVIRONMENT #################### Kirill
WDI_water_stress <- WDI(indicator = "ER.H2O.FWST.ZS") #Level of water stress
WDI_renewable_water <- WDI(indicator = "ER.H2O.INTR.PC") # Renewable internal freshwater resources per capita 
WDI_CO2 <- WDI(indicator = "EN.ATM.CO2E.KT") # CO2 emissions (kt)
WDI_air <- WDI(indicator = "EN.ATM.PM25.MC.M3") # Air pollution

#WDI_pollut_glass <- WDI(indicator = "EE.BOD.CGLS.ZS") # Water pollution, clay and glass industry
#WDI_pollut_chemical <- WDI(indicator = "EE.BOD.CHEM.ZS") # Water pollution, chemical industry
#WDI_pollut_food <- WDI(indicator = "EE.BOD.FOOD.ZS") # Water pollution, food industry
#WDI_pollut_metal <- WDI(indicator = "EE.BOD.MTAL.ZS") # Water pollution, metal industry
#WDI_pollut_other <- WDI(indicator = "EE.BOD.OTHR.ZS") # Water pollution, other industry 
#WDI_pollut_paper <- WDI(indicator = "EE.BOD.PAPR.ZS") # Water pollution, paper and pulp industry
#WDI_pollut_textile <- WDI(indicator = "EE.BOD.TXTL.ZS") # Water pollution, textile industry 
#WDI_pollut_wood <- WDI(indicator = "EE.BOD.WOOD.ZS") # Water pollution, wood industry 


WDI_road %>% group_by(country) %>% 
  summarise(mean = mean(.[[3]], na.rm=T)) %>%
  is.na() %>% summary() #TRUEs = missings for country

### 5 Gapminder ###
#- 6 variables: country, continent, year, lifeExp, pop, gdpPercap
summary(gapminder)
summary(country_codes) #can be added to gapminder data for country codes
col_gap <- cbind(country_colors,continent_colors, labels(country_colors)) %>% as_tibble()
names(col_gap) <- c("cntry_col","cntnt_col","country")
dat_gap <- left_join(gapminder, country_codes)
dat_gap <- left_join(dat_gap, col_gap)

### JOINING DATA ###
#join by country and year
# what?: a lot of WDI_variables and the dat_gap

WDI_list <- list(WDI_ch_mor, 
                 #WDI_ch_mor2, WDI_water2, #thrown out due missings
                 WDI_surv_65f,  WDI_surv_65m, WDI_cook, 
                WDI_mortality, WDI_mor_hyg, #thrown out due missings
                WDI_pri_Ed, WDI_sec_Ed,
                WDI_pri_mon,   WDI_sec_mon, #thrown out due missings
                WDI_sec_f, 
                WDI_road,   #thrown out due missings
                WDI_pois ,   WDI_murder,
                WDI_gini,   WDI_y_unemp, WDI_ad_unemp,  WDI_int_unemp,
                WDI_bas_unemp,
                #WDI_gdp,    WDI_gdpgr,   #thrown out due only missing values
                WDI_renewable_water, WDI_water_stress, #not useable, weird values  
                WDI_CO2,       WDI_air)

#merge data from WDI
dat <- plyr::join_all(dfs = WDI_list, by = c("country","year","iso2c"))
dat <- full_join(dat_gap[,c(1,3:6)], dat, by=c("country","year"))
dat <- full_join(dat_gap[,c(1:2,7:length(dat_gap))], dat, by="country")#
names(dat) <- c("country","continent","iso_alpha","iso_num",
                "cntry_col","cntnt_col","year","lifeExp",
                "pop","gdpPercap","iso2c",
                "child_mor","surv_65f","surv_65m","cook",
                "mortality", "mor_hyg", #thornw out
                "pri_ed","sec_ed",
                "pri_mon",   "sec_mon", #thrown out
                "sec_f",
                "road",  #thrown out
                "poison","murder", "gini",
                "y_unemp","ad_unemp","int_unemp","bas_unemp",
                "renew_wat","water_stress", #not useable
                "CO2","air")

#C: make dataset smaller
#C1: delete countries without continent (like Europe, Virgin Islands, ...)
dat <- dat[!is.na(dat$continent),]
#C2: which columns do have little data?
colNA <- map(dat,~table(is.na(.x))) %>%
  map_int(~.x["FALSE"])
colNA
# RESULT:
# "6.0.GDPpc_constant" doesnt have any data --> throw WDI_gdp out
# "6.0.GDP_growth" doesnt have any data --> throw WDI_gdpgr out
# "ER.H2O.FWST.ZS" has way less data than other vars --> throw WDI_water_stress out
# "SH.STA.AIRP.P5" copy above --> throw WDI_mortality out
# "SH.STA.WASH.P5" copy above --> throw WDI_mor_hyg out
# "fin37.t.a.6" copy above --> throw WDI_sec_mon out
# "fin37.t.a.5§ copy above --> throw WDI_pri_mon out
# "HD.HCI.MORT" copy above --> throw WDI_ch_mor2 out
# "SG.H2O.PRMS.HH.ZS" copy above --> throw WDI_water2 out
# "SH.STA.TRAF.P5" copy above --> throw WDI_road out

#C3: which rows do have little data?
# the answer: many, and every one at least some
# so instead of deleting those with missings, I'd like to shrink years to decades

#let's try this: take value of highest year available
dat <- dat %>% arrange(-year) #arrange descending by year

dat_long <- tidyr::gather(dat, variable, measurement, 
                          c(lifeExp:gdpPercap, child_mor:air))
#delete rows with missings
dat_long <- dat_long[is.na(dat_long$measurement)==F,] %>%
  group_by(country, variable)  %>%
  slice(1) %>% #take first available entry per group 
  ungroup()

#most entries are year=>2000, delete the ones before
dat_long <- dat_long[dat_long$year>=2000,]

#check: any countries with little available variables?
low_data <- dat_long %>%
  group_by(country) %>%
  count() %>% arrange(n)
#ten countries have way less (=3) data available than others(>=13)
temp <- low_data[low_data$n>10,]$country
keep.list <- paste(temp, collapse = '|')
dat_long <- dat_long %>% 
  filter(grepl(keep.list, country))

#dat_long -> dat_wide
dat_wide <- dat_long %>%
  select(-c("year")) %>%  #year must be dropped, can be attached later
  spread(variable, measurement)


#Open Questions:
#-which variables exactly
#-Weighing (each group = 1/6, 
            #maybe scalable as web application?,
            #make model from OECD life satisfaction -> apply to world)
# Exploratory Factor Analysis  <-- We will try this
# include size of country as support quality variable
#-handling missing data (missings probably not random)
#-relations between variables

# Want:
#- A plot which shows multiple placements from multiple variables to see which countries show always better values and which never do. (+ To see variance) => z-standardize and compare


#look at variables
hist(dat_wide$air)
hist(dat_wide$CO2) #?wtf -> needs to by adjusted by population
dat_wide$CO2 <- dat_wide$CO2/dat_wide$pop
hist(dat_wide$CO2) 


cor(dat_wide)
cortab <- rcorr(as.matrix(dat_wide[,8:length(dat_wide)]))
library(corrplot)
corrplot(cortab$r, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)
#check out groups of variables
envir <- c("air","CO2","renew_wat","water_stress")
health <- c("surv_65m","surv_65f","mortality","lifeExp","cook","child_mor")
econ <- c("gdpPercap","gini","y_unemp","ad_unemp","int_unemp","bas_unemp")
educ <- c("pri_ed","sec_ed","pri_mon","sec_mon","sec_f")
secu <- c("mor_hyg","road","poison","murder")
topics <- list(envir,health,econ,educ,secu)

chart.Correlation(as.matrix(dat_wide[,envir]), histogram=TRUE, pch=19)
#renew_wat and water_stress have weird extreme values
#--> do:
remove_outliers <- function(x, na.rm = TRUE, ...) {
  qnt <- quantile(x, probs=c(.25, .75), na.rm = na.rm, ...)
  H <- 1.5 * IQR(x, na.rm = na.rm)
  y <- x
  y[x < (qnt[1] - H)] <- NA
  y[x > (qnt[2] + H)] <- NA
  y
}
dat_wide$renew_wat <- remove_outliers(dat_wide$renew_wat)
dat_wide$water_stress <- remove_outliers(dat_wide$water_stress)
dat_wide$CO2 <- remove_outliers(dat_wide$CO2)
chart.Correlation(as.matrix(dat_wide[,health]), histogram=TRUE, pch=19)
#health looks mostly good
chart.Correlation(as.matrix(dat_wide[,econ]), histogram=TRUE, pch=19)
#unemployment variables are similar
chart.Correlation(as.matrix(dat_wide[,educ]), histogram=TRUE, pch=19)

chart.Correlation(as.matrix(dat_wide[,secu]), histogram=TRUE, pch=19)
```

```{r confirmatory factor analysis}
# test topic groups alone
fa <- topics %>%
  map(~psych::fa(dat_wide[,.x],rotate = "varimax",fm="ml"))

#education: sec_f not good, rest ok
educ <- c("pri_ed","sec_ed","pri_mon","sec_mon")
#econ: unemp is too similar, make rowMeans (different levels of education)
dat_wide <- dat_wide %>% 
  mutate(unemp =  rowMeans(cbind(ad_unemp, bas_unemp, int_unemp), na.rm=T))
econ <- c("gdpPercap","gini","unemp")
#health: is perfect
#security: murder doesnt fit, rest is good
secu <- c("mor_hyg","road","poison") #redone :)
#environment: nur CO2 und air geht
envir <- c("CO2","air")
topics <- list(envir,health,econ,educ,secu)

#run final cfa's
fa <- topics %>%
  map(~psych::fa(dat_wide[,.x],rotate = "varimax",fm="ml"))
fa[[3]]
```

```{r make factor scores}
fa_scores <- fa %>% map2(.y = topics, 
                         .f= ~factor.scores(x=dat_wide[,.y], f=.x, 
                                            impute = "median"))
fa_scores <- map(.x=fa_scores, ~.x[["scores"]])
fa_scores <- matrix(flatten(fa_scores), ncol = 5) %>% as_tibble()
names(fa_scores) <- c("envir","health","econ","educ","secu")
country <- dat_wide$country
fs <- cbind(country, fa_scores)
dat_wide2 <- left_join(dat_wide, fs, by="country")

#which do need to be recoded/ negated?
dat_wide <- dat_wide2 %>%
  mutate(envir = -as.numeric(envir), #environment was wrong, now correct
         health = as.numeric(health),
         econ = as.numeric(econ),
         educ = as.numeric(educ),
         secu = -as.numeric(secu))  #security was wrong, now correct
# now every dimension has this interpretation:
# the higher the value, the better the conditions

#make longformat again
dat_long <- gather(dat_wide, variable, measurement, ad_unemp:secu)
dat_long <- dat_long[is.na(dat_long$measurement)==F,]
dat_raw <- dat

#clean workspace except for necessary data
write.csv(dat_raw, "dat_raw.csv")
write.csv(dat_wide, "dat_wide.csv")
write.csv(dat_long, "dat_long.csv")
rm(list = ls())
dat_raw <- read.csv("dat_raw.csv")
dat_wide <- read.csv("dat_wide.csv")
dat_long <- read.csv("dat_long.csv")

```



# Data Cleaning
```{r cleaning}
#is done mostly
```

# Data Analysis
```{r analysis Lucas}

dat_wide %>% 
  ggplot(aes(x=educ, y=health,
             col = continent, size=pop)) +
  geom_point() +
  geom_smooth(col="blue", method = 'loess') 

dat_wide %>% 
  ggplot(aes(x=educ, y=envir,
             col = continent, size=pop)) +
  geom_point() +
  geom_smooth(col="blue", method = 'loess') 

dat_wide %>% 
  ggplot(aes(x=educ, y=econ,
             col = continent, size=pop)) +
  geom_point() +
  geom_smooth(col="blue", method = 'loess') 

dat_wide %>% 
  ggplot(aes(x=educ, y=secu,
             col = continent, size=pop)) +
  geom_point() +
  geom_smooth(col="blue", method = 'loess') 


```

```{r analysis Mattia}




```

```{r analysis Kirill}

```

## Health Variables

## Economic Variables

## Life Satisfaction variables

## Safety Variables

## Educational variables

## Environmental variables

# Conclussion
